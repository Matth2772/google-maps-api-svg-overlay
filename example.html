
<!DOCTYPE html>
<html>
  <head>
    <title>Google Maps API - Reachability</title>
    <link href="https://google-developers.appspot.com/maps/documentation/javascript/examples/default.css" rel="stylesheet">
    <style type="text/css">
      #map_canvas {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }

      #canvas {
        position: absolute;
        z-index: 1;
        top: 0;
        background-color: rgba(0,0,0,0.5);
      }


    </style>
  </head>
  <body>
    <div id="map_canvas"></div>
    <img id="canvas" />
    <script src="http://maps.googleapis.com/maps/api/js?v=3.exp&amp;libraries=places&amp;sensor=false"></script>
    <script src="svgoverlay.js"></script>
    <script>

      var map = new google.maps.Map(document.getElementById('map_canvas'), {
        zoom: 2,
        center: new google.maps.LatLng(20, 0),
        mapTypeId: google.maps.MapTypeId.ROADMAP
      });

      var xmlhttp = new XMLHttpRequest();
      xmlhttp.open("GET", "example.svg", false);
      xmlhttp.send();
      

      var overlay = new SVGOverlay({ 
        content: xmlhttp.responseText,
        map: map 
      });

      var svg = overlay.getSVG();

      svg.setAttribute("opacity", 0.5);


      function paint(){

        var rule, color, elems, i,
          colors = {
            "1. High income: OECD": "#F00",
            "2. High income: nonOECD": "#F90",
            "3. Upper middle income": "#FF0",
            "4. Lower middle income": "#0CF",
            "5. Low income": "#00F"          
          };

        for (rule in colors){
          elems = svg.querySelectorAll('path[data-income-grp="' + rule + '"]');
          color = colors[rule];

          for (i = 0; i < elems.length; i++){
            elems[i].setAttribute("fill", color);
          }
        }

      }

      paint();

      var img = document.getElementById("canvas");

      function draw(){

        var center = new google.maps.LatLng(0,0),
          // compute map offset
          projection = overlay.getProjection(),
          divPixel = projection.fromLatLngToDivPixel(center),
          containerPixel = projection.fromLatLngToContainerPixel(center),

          // compute container offset.
          styles = overlay.getContainer().style,
          left = parseInt(styles.left, 10),
          top = parseInt(styles.top, 10),

          x = divPixel.x - containerPixel.x - left,
          y = divPixel.y - containerPixel.y - top,

          // create new svg container
          svg = overlay.getSVG().cloneNode(true),
          xml = document.implementation.createDocument(),
          div = document.createElement('div'),
          wrapper = xml.createElement("svg"),

          // get map dimension
          mapDiv = map.getDiv(),
          width = mapDiv.clientWidth,
          height = mapDiv.clientHeight,

          // set svg clipping
          viewBox = [x, y, width, height].join(" ");

        wrapper.setAttribute("xmlns", "http://www.w3.org/2000/svg");
        wrapper.setAttribute("width", width);
        wrapper.setAttribute("height", height);
        wrapper.setAttribute("viewBox", viewBox);

        wrapper.appendChild(svg);
        div.appendChild(wrapper);

        var DOMURL = self.URL || self.webkitURL || self;

        var blob = new Blob([div.innerHTML], {
          type: "image/svg+xml;charset=utf-8"
        });

        var url = DOMURL.createObjectURL(blob);
        
        img.src = url;
      }

 
      
    </script>
  </body>
</html>
